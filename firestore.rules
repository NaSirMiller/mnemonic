rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
        function isValidCourse(data) {
            return data.userId is string &&
                   data.courseName is string;
        }
        }
        function isValidTask(data) {
            return data.userId is string &&
                   data.title is string &&
                   data.courseId is string &&
                   (data.weight is number && (data.weight >=0 && data.weight <= 1.00)) &&
                   data.dueDate is timestamp &&
                   data.get("description", "") is string &&
                   (data.grade is number || data.grade == null) && // Grade can be added later by user
                   (data.lastProgressed is timestamp || data.lastProgressed == null) && // Last tracked date where progress was made. For example, this date changes if the the time spent for the session > 0.
                   data.timeSpent is number && // Total amount of time spent towards the task
                   data.isComplete is bool &&
                   (data.priority is number || data.priority == null) // Task priority
                   data.createdAt is timestamp &&
                   data.lastUpdatedAt is timestamp
        }
        function isValidUser(data) {
            return data.userId is string &&
                (data.displayName is string || data.displayName == null) &&
                (data.email is string || data.email == null);
        }

        function isValidRefreshToken(data) {
            return data.refreshToken is string;
        }

        // --- Global Defaults ---
        allow read: if false; // no public reads unless specified

        // --- Courses ---
        match /courses/{course} {
            allow read: if request.auth != null &&
                            resource.data.userId;
            allow create: if request.auth.uid == request.resource.data.userId &&
                            isValidCourse(request.resource.data);
            allow update, delete: if request.auth.uid == resource.data.userId;
        }

        // --- Tasks ---
        match /tasks/{task} {
            allow read: if request.auth != null && request.auth.uid == resource.data.userId;
            allow create: if request.auth != null &&
                        request.auth.uid == request.resource.data.userId &&
                        isValidTask(request.resource.data);
            allow update: if request.auth != null &&
                        request.auth.uid == resource.data.userId &&
                        isValidTask(request.resource.data);
            allow delete: if request.auth != null &&
                            request.auth.uid == resource.data.userId;
               }
        // --- Users ---
         match /users/{userId} {
        
            // Clients can read their own user info, but NEVER refreshToken
            allow read: if request.auth != null &&
                        request.auth.uid == userId &&
                        !("refreshToken" in resource.data);

            // Clients can create/update their own user document (without touching refreshToken)
            allow create, update: if request.auth != null &&
                                    request.auth.uid == request.resource.data.userId &&
                                    isValidUser(request.resource.data);

            // Server or trusted environment can update refreshToken
            allow update: if request.auth != null &&
                            request.auth.uid == userId &&
                            isValidRefreshToken(request.resource.data);

            // Clients can delete their own document
            allow delete: if request.auth != null &&
                            request.auth.uid == resource.data.userId;
        }
    }
